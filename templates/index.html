<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rule Engine</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>

<body>
    <h1>Rule Engine</h1>

    <!-- Create Rule Form -->
    <h2>Create a Rule</h2>
    <form id="rule-form">
        <label for="rule_string">Enter Rule:</label>
        <input type="text" id="rule_string" name="rule_string" required>
        <button type="submit">Create Rule</button>
    </form>

    <!-- Combine Rules Form -->
    <h2>Combine Rules</h2>
    <form id="combine-form">
        <label>Select Rules to Combine:</label><br>
        {% for rule in rules %}
        <input type="checkbox" name="rule_ids" value="{{ rule.id }}"> {{ rule.rule_string }}<br>
        {% endfor %}
        <button type="submit">Combine Rules</button>
    </form>

    <!-- Display Combined Rule -->
    <h2>Combined Rule Output:</h2>
    <pre id="combined-rule-output"></pre>

    <!-- Display Combined Rule as Expression -->
    <h2>Combined Rule Expression:</h2>
    <pre id="combined-rule-expression"></pre>


    <form id="evaluate-form">
        <label for="rule_id">Select Rule:</label>
        <select id="rule_id" name="rule_id" required>
            {% for rule in rules %}
            <option value="{{ rule.id }}">{{ rule.rule_string }}</option>
            {% endfor %}
        </select>
        <label for="user_data">User Data (JSON):</label>
        <textarea id="user_data" name="user_data" required></textarea>
        <button type="submit">Evaluate Rule</button>
    </form>


    <script>
        // AST to readable expression function
        function astToExpression(node) {
            if (!node) return '';

            // If the node is an operand (leaf node), just return its value
            if (node.type === 'operand') {
                return node.value;
            }

            // If the node is an operator, recursively process left and right nodes
            if (node.type === 'operator') {
                const leftExpr = astToExpression(node.left);
                const rightExpr = astToExpression(node.right);

                // Return the expression in the format "(left_expr operator right_expr)"
                return `(${leftExpr} ${node.value} ${rightExpr})`;
            }

            return '';
        }

        // Form submission for creating a rule
        document.getElementById('rule-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const rule_string = document.getElementById('rule_string').value;
            const response = await fetch('/create_rule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ rule_string })
            });
            const data = await response.json();
            alert(data.status);
            location.reload();  // Reload the page to display the new rule
        });

        // Form submission for combining rules
        document.getElementById('combine-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const selectedRules = Array.from(document.querySelectorAll('input[name="rule_ids"]:checked')).map(cb => cb.value);

            if (selectedRules.length === 0) {
                alert("Please select at least one rule to combine.");
                return;
            }

            const response = await fetch('/combine_rules', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rule_ids: selectedRules })
            });

            const data = await response.json();
            if (response.ok) {
                // Display the combined rule as JSON
                const combinedRuleOutput = document.getElementById('combined-rule-output');
                combinedRuleOutput.textContent = JSON.stringify(data.combined_rule, null, 2);

                // Convert AST to a readable expression and display it
                const combinedRuleExpression = document.getElementById('combined-rule-expression');
                const expression = astToExpression(data.combined_rule);
                combinedRuleExpression.textContent = expression;

                // Also alert the expression
                alert('Combined Rule Expression: ' + expression);
            } else {
                alert('Error: ' + data.error);
            }
        });

        // Form submission for evaluating a rule
       document.getElementById('evaluate-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const rule_id = document.getElementById('rule_id').value;
            const user_data = document.getElementById('user_data').value;

            const response = await fetch('/evaluate_rule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    rule_id: rule_id,
                    user_data: JSON.parse(user_data)  // Convert user_data from string to JSON object
                })
            });

            const data = await response.json();
            alert('Evaluation Result: ' + data.result);
            console.log(data.result)
        });


    </script>
</body>

</html>